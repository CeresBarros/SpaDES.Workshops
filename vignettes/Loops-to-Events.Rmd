---
title: "Moving from loops to events"
author: "Eliot J. B. McIntire"
date: "`r strftime(Sys.Date(), '%B %d %Y')`"
output:
  ioslides_presentation: default
  slidy_presentation: default
vignette: |
  %\VignetteEngine{knitr::rmarkdown} %\VignetteIndexEntry{01 Diving into SpaDES} %\VignetteDepends{SpaDES.core, SpaDES.tools} %\VignetteKeyword{discrete event simulation, spatial simulation models, workshops} %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(cache = FALSE, echo = TRUE, eval = FALSE)
```

## Loops

- A fundamental unit of computer programs is the loop
- Used in virtually every computer language
- However, with *R* and `SpaDES`, there are 2 reasons not to:

    - They are somewhat slow
    - They don't allow easy sharing of code
  
## Loops in time

- Some loops are used where *time* is the object moving forward
- If one loop iteration depends on the previous loop iteration 
- Called a **Markov Chain**

```{r}
age <- 1
for (time in 1:10) {
  age <- age + 1
}
```

## Events

- Rather than "iterating", we can think of "events"
- Spring thaw  
<br>
![](http://www.premier-roofing.com/wp-content/uploads/2014/03/stock-footage-spring-thaw-time-lapse.jpg)
- Brainstorm events...

## Events instead of loops

- Rather than `for ...`, we **schedule** the next event
- It would be something like this:

```{r loopsToEvents}
age <- 1

# define event
aging <- age + 1

events <- {
  doEvent("aging")
  scheduleEvent("aging", when = now + 1)
}

times = list(start = 1, end = 10) 
```


## Parts of a loop

- Setting up (sometimes required), **initializing**
```{r}
age <- 1
```

- deciding on **bounds** and **intermediates** or "step"
    - lower bound = 1 to upper bound = 10
    - here step is 1 (i.e., 1, 2, 3, 4, ... 10)

```{r}
... in 1:10
```

- **content**
```{r}
age <-  age + 1
```

## Moving to events

- Need same as a loop: 

**initialize**, **bounds**, **step**, **content**

```{r}
age <- 1                                 # Initialize

# define event
aging <- function(age) {
  age <- age + 1                         # content
  scheduleEvent("aging", when = now + 1) # step
}

times = list(start = 1, end = 10)        # bounds

```

## How to do that in SpaDES

- create a new "empty" module
- we will put the pieces in specific places so it works

```{r}
newModule("loop", path = "~")
# This will make a new module, and 
#  tell you how to open it in the message 
```

- Open the module -- the file that ends with `.R`

## Simple module

- Comes with 2 files, an `.R` file and a `.Rmd` file

```{r}
doEvent.loop = function(sim, eventTime, eventType, debug = FALSE) {
  switch(
    eventType,
    init = {
      sim <- scheduleEvent(sim, start(sim), "loop", "addOneYear")
    },
    addOneYear = {
      sim$age <- sim$age + 1
      sim <- scheduleEvent(sim, time(sim) + 1, "loop", "addOneYear")
    },
  )
  return(invisible(sim))
}
```

